<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tris Online (Firebase v9)</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background: #fafafa;
      }
      #board {
        display: grid;
        grid-template-columns: repeat(3, 100px);
        grid-template-rows: repeat(3, 100px);
        gap: 10px;
        margin: 1em;
      }
      .cell {
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #0078ff;
        font-size: 2.5rem;
        width: 100px;
        height: 100px;
        cursor: pointer;
        background: white;
      }
      .cell.win {
        background: #2ecc71;
        color: white;
      }
      button {
        background: #0078ff;
        color: white;
        border: none;
        padding: 0.5em 1em;
        border-radius: 8px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>Tris Online</h1>
    <div id="status"></div>
    <div id="board"></div>
    <button id="newGame">New Game</button>

    <!-- Import Firebase modular SDKs -->
    <script type="module">
      // Import Firebase SDKs from the official CDN
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
      import {
        getDatabase,
        ref,
        get,
        set,
        update,
        onValue,
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

      // Your web app's Firebase configuration (you provided this)
      const firebaseConfig = {
        apiKey: "AIzaSyCRkMvnNsh_c9AGP4YYudqND1hMysbW1JQ",
        authDomain: "tris-online-9236a.firebaseapp.com",
        databaseURL: "https://tris-online-9236a-default-rtdb.firebaseio.com",
        projectId: "tris-online-9236a",
        storageBucket: "tris-online-9236a.firebasestorage.app",
        messagingSenderId: "907067795087",
        appId: "1:907067795087:web:f244f2b32f391bc56eb2fa",
        measurementId: "G-3XFX5G2V0C",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const db = getDatabase(app);

      // DOM references
      const boardEl = document.getElementById("board");
      const statusEl = document.getElementById("status");
      const newBtn = document.getElementById("newGame");

      // Game state
      let gameId = null;
      let uid = Math.random().toString(36).slice(2, 9);
      let symbol = "X";
      let board = Array(9).fill("");
      let current = "X";
      let gameOver = false;

      // --- UI rendering ---
      function renderBoard() {
        boardEl.innerHTML = "";
        board.forEach((v, i) => {
          const c = document.createElement("div");
          c.className = "cell";
          c.textContent = v;
          c.onclick = () => makeMove(i);
          boardEl.appendChild(c);
        });
      }

      // --- Game setup ---
      async function createOrJoinGame() {
        const hash = location.hash.replace("#", "");
        if (hash) {
          // join existing
          gameId = hash;
          const snap = await get(ref(db, "games/" + gameId));
          if (snap.exists()) {
            const data = snap.val();
            board = data.board;
            current = data.current;
            symbol = data.players.X ? "O" : "X";
            await set(ref(db, "games/" + gameId + "/players/" + symbol), uid);
            statusEl.textContent = "Joined game as " + symbol;
          } else {
            alert("Game not found!");
            return;
          }
        } else {
          // create new
          gameId = Math.random().toString(36).slice(2, 7);
          location.hash = gameId;
          await set(ref(db, "games/" + gameId), {
            board: Array(9).fill(""),
            current: "X",
            players: { X: uid },
            status: "waiting",
          });
          symbol = "X";
          statusEl.textContent =
            "Created game. Share this link: " + location.href;
        }

        // Listen for changes
        onValue(ref(db, "games/" + gameId), (snap) => {
          const data = snap.val();
          if (!data) return;
          board = data.board;
          current = data.current;
          renderBoard();
          checkWinnerLocal();
          if (data.status === "waiting" && data.players.O) {
            update(ref(db, "games/" + gameId), { status: "playing" });
            statusEl.textContent = "Game started!";
          } else if (data.status === "playing") {
            statusEl.textContent =
              current === symbol ? "Your turn" : "Opponentâ€™s turn";
          } else if (data.status === "finished") {
            statusEl.textContent = data.message;
          }
        });
      }

      // --- Make a move ---
      function makeMove(i) {
        if (gameOver || board[i] != "" || current !== symbol) return;
        board[i] = symbol;
        const winner = checkWinnerLocal();
        if (winner) {
          update(ref(db, "games/" + gameId), {
            board,
            status: "finished",
            message: `${winner} wins!`,
          });
          gameOver = true;
          return;
        }
        if (board.every((c) => c != "")) {
          update(ref(db, "games/" + gameId), {
            board,
            status: "finished",
            message: "Draw!",
          });
          gameOver = true;
          return;
        }
        current = current === "X" ? "O" : "X";
        update(ref(db, "games/" + gameId), { board, current });
      }

      // --- Check winner ---
      function checkWinnerLocal() {
        const combos = [
          [0, 1, 2],
          [3, 4, 5],
          [6, 7, 8],
          [0, 3, 6],
          [1, 4, 7],
          [2, 5, 8],
          [0, 4, 8],
          [2, 4, 6],
        ];
        const cells = document.querySelectorAll(".cell");
        for (let [a, b, c] of combos) {
          if (board[a] && board[a] === board[b] && board[a] === board[c]) {
            [a, b, c].forEach((i) => cells[i]?.classList.add("win"));
            gameOver = true;
            return board[a];
          }
        }
        return null;
      }

      // --- ðŸ†• Restart / New Game ---
      newBtn.onclick = () => {
        // Generate a new random game ID
        const newId = Math.random().toString(36).slice(2, 7);
        // Reset the URL to remove the old one and set the new one
        location.hash = newId;
        // Reset local state
        board = Array(9).fill("");
        current = "X";
        gameOver = false;
        symbol = "X";
        renderBoard();
        statusEl.textContent =
          "Created a new game. Share this link: " + location.href;
        // Create new game node in Firebase
        set(ref(db, "games/" + newId), {
          board: Array(9).fill(""),
          current: "X",
          players: { X: uid },
          status: "waiting",
        });
        // Stop listening to the old game node and start listening to the new one
        dbRef = ref(db, "games/" + newId);
        onValue(dbRef, handleGameUpdate);
      };

      // --- ðŸ§  Shared update handler for both create/join ---
      function handleGameUpdate(snap) {
        const data = snap.val();
        if (!data) return;
        board = data.board;
        current = data.current;
        renderBoard();
        checkWinnerLocal();
        if (data.status === "waiting" && data.players.O) {
          update(ref(db, "games/" + gameId), { status: "playing" });
          statusEl.textContent = "Game started!";
        } else if (data.status === "playing") {
          statusEl.textContent =
            current === symbol ? "Your turn" : "Opponentâ€™s turn";
        } else if (data.status === "finished") {
          statusEl.textContent = data.message;
        }
      }

      // --- Start ---
      renderBoard();
      createOrJoinGame();
    </script>
  </body>
</html>
