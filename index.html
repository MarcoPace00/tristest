<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tris Online</title>
<style>
  body{font-family:sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:#fafafa;margin:0}
  #board{display:grid;grid-template-columns:repeat(3,100px);grid-template-rows:repeat(3,100px);gap:10px;margin:1rem}
  .cell{display:flex;align-items:center;justify-content:center;font-size:2.5rem;border:2px solid #0078ff;background:white;cursor:pointer;user-select:none}
  .cell.win{background:#2ecc71;color:white}
  button{margin:.5rem;padding:.5rem 1rem;border:none;border-radius:6px;background:#0078ff;color:#fff;cursor:pointer}
  #status{margin-top:.5rem;font-weight:bold}
  #link{color:#0078ff;font-size:.9rem;margin-top:.25rem;word-break:break-all;text-align:center}
</style>
</head>
<body>
<h1>Tris Online</h1>
<div id="status">Loading...</div>
<div id="board"></div>
<button id="new">New Game</button>
<div id="link"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, get, set, update, onValue, off } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCRkMvnNsh_c9AGP4YYudqND1hMysbW1JQ",
  authDomain: "tris-online-9236a.firebaseapp.com",
  databaseURL: "https://tris-online-9236a-default-rtdb.firebaseio.com",
  projectId: "tris-online-9236a",
  storageBucket: "tris-online-9236a.firebasestorage.app",
  messagingSenderId: "907067795087",
  appId: "1:907067795087:web:f244f2b32f391bc56eb2fa"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const boardEl=document.getElementById("board");
const statusEl=document.getElementById("status");
const newBtn=document.getElementById("new");
const linkEl=document.getElementById("link");

let uid=Math.random().toString(36).slice(2,9);
let board=Array(9).fill("");
let current="X";
let symbol="X";
let gameId=null;
let gameRef=null;
let gameOver=false;
let stopListen=null;

const combos=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];

function render(){
  boardEl.innerHTML="";
  board.forEach((val,i)=>{
    const d=document.createElement("div");
    d.className="cell";
    d.textContent=val;
    d.onclick=()=>move(i);
    boardEl.appendChild(d);
  });
}

function winCheck(){
  const cells=document.querySelectorAll(".cell");
  for(let [a,b,c] of combos){
    if(board[a] && board[a]===board[b] && board[a]===board[c]){
      [a,b,c].forEach(i=>cells[i].classList.add("win"));
      gameOver=true;
      return board[a];
    }
  }
  return null;
}

async function move(i){
  if(gameOver || board[i] || current!==symbol)return;
  board[i]=symbol;
  const winner=winCheck();
  if(winner){
    await update(gameRef,{board,status:`${winner} wins`});
    return;
  }
  if(board.every(c=>c)){
    await update(gameRef,{board,status:"Draw"});
    return;
  }
  current=current==="X"?"O":"X";
  await update(gameRef,{board,current,status:"playing"});
}

function listen(){
  if(stopListen) off(gameRef);
  onValue(gameRef,snap=>{
    const data=snap.val(); if(!data)return;
    board=data.board; current=data.current;
    render();
    const w=winCheck();
    if(data.status==="waiting") statusEl.textContent="Waiting for opponent...";
    else if(data.status==="playing") statusEl.textContent=current===symbol?"Your turn":"Opponent's turn";
    else statusEl.textContent=data.status;
  });
}

async function createGame(){
  if(stopListen) off(gameRef);
  board=Array(9).fill("");
  current="X"; symbol="X"; gameOver=false;
  gameId=Math.random().toString(36).slice(2,7);
  gameRef=ref(db,"games/"+gameId);
  await set(gameRef,{board,current,status:"waiting",players:{X:uid}});
  location.hash=gameId;
  linkEl.textContent="Share this link with your friend: "+location.href;
  listen();
}

async function joinGame(id){
  gameId=id;
  gameRef=ref(db,"games/"+id);
  const snap=await get(gameRef);
  if(!snap.exists()){statusEl.textContent="Game not found.";return;}
  const data=snap.val();
  symbol=data.players && data.players.X?"O":"X";
  await update
